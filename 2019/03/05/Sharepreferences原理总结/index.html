<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Li Jiangtao"><link rel="alternative" href="/atom.xml" title="zhulinyin" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Sharepreferences原理总结 - zhulinyin</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">zhulinyin</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">目录</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2019-03-05T14:54:55.000Z">March 5, 2019</time><h1 class="post__title"><a href="/2019/03/05/Sharepreferences原理总结/">Sharepreferences原理总结</a></h1><div class="post__main echo"><ol>
<li><code>SharedPreferences getSharedPreferences(String name, int mode)</code>：根据应用名称和文件名获取<code>SharedPreferencesImpl</code>对象（该类实现了<code>SharedPreferences</code>接口），如果不存在则直接创建，创建<code>SharedPreferencesImpl</code>对象的过程是开启线程从硬盘读取文件。</li>
<li><code>String getString(String key, @Nullable String defValue)</code>：从map中获取value。</li>
<li><code>Editor edit()</code>：创建<code>EditorImpl</code>对象（该类实现了<code>Editor</code>接口），创建一个临时的map用于存储修改的键值对。</li>
<li><code>Editor putString(String key, @Nullable String value)</code>：往临时的map中插入键值对。</li>
<li><code>boolean commit()</code>：首先将sp的数据同步到最新状态，然后在当前线程写入文件，通知监听器数据已发生改变，最后返回写操作状态是否成功。</li>
<li><code>void apply()</code>：和commit主要区别就是apply的写文件操作会在一个线程中执行，不会阻塞UI线程。</li>
</ol>
<h3 id="commit-和apply-的对比"><a href="#commit-和apply-的对比" class="headerlink" title="commit()和apply()的对比"></a>commit()和apply()的对比</h3><p>如果我们使用SharedPreference的apply方法, 虽然该方法可以很快返回，并在其它线程里将键值对写入到文件系统，但是当Activity的onPause/onStop等方法被调用时，会等待写入到文件系统的任务完成，如果写入比较慢，主线程就会出现ANR问题。为了避免出现ANR问题，最好还是别使用apply操作，用commit方法最保险。如果担心在主线程调用commit方法会出现ANR，可以将所有的commit任务放到单线程池的线程里去执行。</p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/Android/">Android</a></li></ul></footer></article></main><footer class="foot"><div class="foot-copy">&copy; 2018-2019 Li Jiangtao</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>